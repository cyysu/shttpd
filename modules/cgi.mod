# Add CGI support to shttpd

call_cgi() {
	# TODO: REMOTE_ADDR (is that even possible with nc?)
	GATEWAY_INTERFACE="CGI/1.1"
	PATH_INFO="/$path"
	SCRIPT_NAME="/$path"
	SERVER_NAME="$HOSTNAME"
	CONTENT_LENGTH="$HTTP_CONTENT_LENGTH"
	CONTENT_TYPE="$HTTP_CONTENT_TYPE"
	SCRIPT_FILENAME="$PATH_TRANSLATED"
	export QUERY_STRING REQUEST_METHOD PATH_TRANSLATED SERVER_PORT SERVER_SOFTWARE SERVER_PROTOCOL GATEWAY_INTERFACE PATH_INFO SCRIPT_NAME SERVER_NAME CONTENT_LENGTH CONTENT_TYPE SCRIPT_FILENAME
	if [ "$1" != "-n" ]; then # Supress output
		printf "%b" "HTTP/1.1\r\n"
	else
		shift
	fi
	"$@"
}

if [ -f "$PATH_TRANSLATED" -a -x "$PATH_TRANSLATED" ]; then
	call_cgi "$PATH_TRANSLATED"
	exit
fi
